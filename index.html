<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Fetch Example</title>
</head>

<body>
  <button id="fetchButton" disabled>Fetch Locations</button>

  <input type="file" id="image">
  <button id="getanalysis"> download </button>

  <script>

    let file = null;

    document.getElementById('image').addEventListener("change", (event) => {
        const fileSelected = event.target.files[0]; // Access the first selected file
        console.log('file selected', fileSelected)
        if (fileSelected) {
          getAnalysis(fileSelected);

          // If needed, you can also create a URL for previewing the file (for images)
          if (fileSelected.type.startsWith('image/')) {
            const imageUrl = URL.createObjectURL(fileSelected);
            console.log('Image URL:', imageUrl);

            // Display the image preview in an <img> element
            const imgElement = document.createElement('img');
            imgElement.src = imageUrl;
            imgElement.style.maxWidth = '100%'; // Adjust styling as needed
            document.body.appendChild(imgElement); // Append to body or another container
          }
        }
    })

    async function getAnalysis(file) {
      const URL = `https://api.plantix.net/v2/image_analysis`;

      const formData = new FormData();
      formData.append('image', file);
      formData.append('application_used_image_gallery', false);

      fetch(URL, {
        method: 'POST',
        headers: new Headers({
          Authorization: "Bearer ee371caf6cecaca9c76e1475f0491493dc8dc3c0",
          accept: "application/json",
          'Content-Type': 'multipart/form-data'
        }),
        body: formData
      })
        .then(res => res.json())
        .then(res => {
          console.log('res', res)
        }).catch(error => {
          console.log('api error', error)
          console.log(error.message)
        }).finally(() => {
        })
    }

    document.getElementById('fetchButton').addEventListener('click', async () => {
      try {

        const filterQuery = {
          fields: {
            id: true,
            name: true
          }
        }

        const response = await fetch('https://weather.fyllo.in/locations?filter=' + JSON.stringify(filterQuery));
        const locations = await response.json();

        const ids = locations.map(location => location.id);

        console.log('ids', ids);

        for (const id of ids) {
          console.log('refreshing', id);
          await fetchLocationDetails(id);
          await delay(5000);
        }
      } catch (error) {
        console.error('Error fetching locations:', error);
      }
    });

    // Function to fetch location details
    async function fetchLocationDetails(id) {
      try {
        const response = await fetch(`https://weather.fyllo.in/locations/${id}/refresh/combined/hourly`);
        const details = await response.json();
        console.log('Location details:', details);
      } catch (error) {
        console.error(`Error fetching details for location ${id}:`, error);
      }
    }

    // Function to create a delay
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  </script>
</body>

</html>